name: Enterprise ETL Build (Kaniko)
on: [push]

jobs:
  build-and-package:
    runs-on: ubuntu-latest
    # Define a container to run the build directly in Kaniko
    container:
      image: gcr.io/kaniko-project/executor:latest
      options: --user root
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      # Step 1: Generate Enterprise ZIP Artifact
      - name: Build Gradle Artifact
        run: |
          gradle wrapper
          ./gradlew assemble
      
      # Step 2: Upload ZIP for Manual Download
      - name: Upload ZIP Package
        uses: actions/upload-artifact@v4
        with:
          name: etl-components-zip
          path: build/distributions/*.zip

      # 2. Build OCI Image with Kaniko (No Push)
      # We use the official executor to avoid "password variable" errors
      - name: Build OCI Image (No Push)
        run: |
          /kaniko/executor \
            --context "${{ github.workspace }}" \
            --dockerfile "${{ github.workspace }}/Dockerfile" \
            --no-push \
            --tar-path "${{ github.workspace }}/etl-image.tar" \
            --destination "etl-component:latest" \
            --skip-tls-verify-pull

      # 2. Upload the built Image TAR for download
      - name: Upload Image Artifact
        uses: actions/upload-artifact@v4
        with:
          name: etl-container-image
          path: etl-image.tar
