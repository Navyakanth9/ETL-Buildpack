name: Enterprise ETL Build (Kaniko)
on: [push]

jobs:
  build-and-package:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      # Step 1: Generate Enterprise ZIP Artifact
      - name: Build Gradle Artifact
        run: |
          gradle wrapper
          ./gradlew assemble
      
      # Step 2: Upload ZIP for Manual Download
      - name: Upload ZIP Package
        uses: actions/upload-artifact@v4
        with:
          name: etl-components-zip
          path: build/distributions/*.zip

      # Step 3: Build OCI Image using Kaniko (No Push)
      # For enterprise use, replace --no-push with your registry destination
      - name: Build OCI Image with Kaniko
        uses: aevea/action-kaniko@master
        with:
          image: etl-component
          tag: latest
          # Satisfy the internal validation even with --no-push
          password: ${{ secrets.GITHUB_TOKEN }}
          extra_args: "--no-push --cache=true"
