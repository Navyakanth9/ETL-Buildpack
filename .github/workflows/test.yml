name: Test Buildpack CI
on: [push, pull_request]

jobs:
  test-buildpack:
    runs-on: ubuntu-latest  # Uses GitHub-hosted runner with Docker pre-installed
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      # 1. Setup Java for Gradle (if your ETL requires specific Java versions)
      - name: Set up JDK
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'
          cache: 'gradle'  # Automatically caches dependencies for speed
       
      # NEW STEP: Generates the missing gradlew file on the runner
      - name: Generate Gradle Wrapper
        run: gradle wrapper    

      # 2. Test Artifact Creation
      - name: Build Artifacts (Zip/Tar)
        run: ./gradlew assemble
    
      # 3. Build OCI Image (Step-by-Step without Dockerfile)
      - name: Build OCI Image with Buildah
        run: |
          # 1. Initialize container from Red Hat UBI
          container=$(buildah from registry.access.redhat.com)
          
          # 2. Copy source into the container
          buildah copy "$container" . /workspace
          buildah config --workingdir /workspace "$container"
          
          # 3. Execute Buildpack logic (Separate RUN commands)
          buildah run "$container" chmod +x bin/detect bin/build
          buildah run "$container" ./bin/detect
          buildah run "$container" ./bin/build
          
          # 4. Set Runtime Configuration
          buildah config --entrypoint '["/bin/ksh", "/workspace/bin/sample_etl.ksh"]' "$container"
          
          # 5. Commit to a permanent image
          buildah commit "$container" etl-component:latest
          echo "Image built successfully: etl-component:latest"

      # 4. Upload Outputs
      - name: Upload ZIP Package
        uses: actions/upload-artifact@v4
        with:
          name: etl-zip-package
          path: build/distributions/*.zip
