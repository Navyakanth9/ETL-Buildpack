name: Enterprise ETL Build (Kaniko)
on: [push]

jobs:
  build-and-package:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      # Step 1: Generate Enterprise ZIP Artifact
      - name: Build Gradle Artifact
        run: |
          gradle wrapper
          ./gradlew assemble
      
      # Step 2: Upload ZIP for Manual Download
      - name: Upload ZIP Package
        uses: actions/upload-artifact@v4
        with:
          name: etl-components-zip
          path: build/distributions/*.zip

      # 2. Build OCI Image with Kaniko (No Push)
      # We use the official executor to avoid "password variable" errors
      - name: Build OCI Image with Kaniko
        run: |
          docker run \
            -v $(pwd):/workspace \
            gcr.io/kaniko-project/executor:latest \
            --dockerfile /workspace/Dockerfile \
            --context dir:///workspace \
            --no-push \
            --tar-path /workspace/etl-image.tar \
            --destination local-build:latest

      # 3. Upload Outputs (ZIP and the OCI Image TAR)
      - name: Upload Build Outputs
        uses: actions/upload-artifact@v4
        with:
          name: etl-build-package
          path: |
            build/distributions/*.zip
            etl-image.tar
